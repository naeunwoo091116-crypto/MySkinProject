<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>NutriAdvisor PRO - Rapid Loop</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==================== DESIGN SYSTEM ==================== */
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --dark-btn: #1F2937;
            --bg-page: #F3F4F6;
            --white: #FFFFFF;
            --text-main: #111827;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --info: #3B82F6;
            --radius-card: 24px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background: var(--bg-page);
            color: var(--text-main);
            padding-bottom: 90px;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-content {
            text-align: center;
            animation: fadeUp 0.8s ease-out;
        }

        .splash-logo {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 24px;
            display: inline-block;
        }

        .splash-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1.4;
            margin: 0;
        }

        .splash-sub {
            font-size: 14px;
            color: var(--text-sub);
            margin-top: 8px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .toast {
            background: rgba(31, 41, 55, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            width: 100%;
            pointer-events: auto;
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.95);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.95);
        }

        .toast i {
            font-size: 20px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Layout */
        .container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-page);
            position: relative;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(243, 244, 246, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-pro {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            vertical-align: middle;
        }

        .status-pill {
            background: #E5E7EB;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .status-pill.connected {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9CA3AF;
            margin-right: 4px;
        }

        .status-pill.connected .status-dot {
            background: #10B981;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeUp 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: 0;
            }
        }

        /* Components */
        .card {
            background: var(--white);
            border-radius: var(--radius-card);
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin: 24px 0 12px 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Home */
        .welcome-banner {
            background: linear-gradient(135deg, #4ADE80 0%, #10B981 100%);
            border-radius: var(--radius-card);
            padding: 30px 24px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
            margin-bottom: 24px;
        }

        .welcome-banner::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 32px;
        }

        .action-btn {
            background: var(--white);
            border-radius: var(--radius-card);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-icon-circle {
            width: 50px;
            height: 50px;
            background: #F3F4F6;
            border-radius: 16px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-main);
        }

        .action-btn.primary .action-icon-circle {
            background: #D1FAE5;
            color: var(--primary);
        }

        .h-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin: 0 -20px;
            padding: 0 20px 10px 20px;
            scrollbar-width: none;
        }

        .course-item {
            min-width: 140px;
            background: var(--white);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }

        .course-item:active {
            transform: scale(0.95);
        }

        .course-dot {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Camera */
        .camera-frame {
            background: #000;
            border-radius: var(--radius-card);
            height: 480px;
            width: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .face-guide-overlay {
            position: absolute;
            width: 260px;
            height: 340px;
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 140px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
        }

        .face-map-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            background: #000;
        }

        .face-map-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 1;
        }

        /* Buttons & Inputs */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }

        .btn-half {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            background: white;
            border: 1px solid #E5E7EB;
            color: var(--text-main);
        }

        .btn-capture {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid #E5E7EB;
            margin: 0 auto;
            display: block;
            cursor: pointer;
            position: relative;
        }

        .btn-capture::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 54px;
            height: 54px;
            background: var(--primary);
            border-radius: 50%;
            transition: 0.2s;
        }

        .btn-capture:active::after {
            transform: translate(-50%, -50%) scale(0.9);
        }

        .btn-dark {
            width: 100%;
            padding: 18px;
            background: var(--dark-btn);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-green {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 16px;
            margin-top: 12px;
            cursor: pointer;
        }

        .chart-box {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            height: 300px;
            position: relative;
            margin-bottom: 24px;
        }

        .solution-card {
            background: #ECFDF5;
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mask-visual {
            width: 160px;
            height: 220px;
            margin: 0 auto 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 130'%3E%3Cpath d='M50 5 C20 5 5 25 5 60 C5 95 25 125 50 125 C75 125 95 95 95 60 C95 25 80 5 50 5 Z' fill='none' stroke='%23D1D5DB' stroke-width='3'/%3E%3Cpath d='M30 45 Q35 40 40 45 M60 45 Q65 40 70 45' stroke='%23E5E7EB' stroke-width='2' fill='none'/%3E%3Cpath d='M45 80 Q50 85 55 80' stroke='%23E5E7EB' stroke-width='2' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            transition: 0.3s;
        }

        .mask-visual.red {
            filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.6));
        }

        .mask-visual.blue {
            filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.6));
        }

        .mask-visual.gold {
            filter: drop-shadow(0 0 15px rgba(245, 158, 11, 0.6));
        }

        .mode-toggles {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .mode-btn {
            flex: 1;
            padding: 16px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            border-color: var(--primary);
            background: #ECFDF5;
            color: var(--primary-dark);
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        input[type=range] {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 30px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .preset-chip {
            min-width: 100px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .preset-chip:active {
            transform: scale(0.95);
            background: #f9fafb;
        }

        .preset-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
            color: var(--text-main);
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #F3F4F6;
            padding: 12px 20px 24px;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: #9CA3AF;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .nav-item.active {
            color: var(--primary-dark);
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>

<body>

    <div id="splash-screen">
        <div class="splash-content">
            <i class="ph-fill ph-plant splash-logo"></i>
            <h1 class="splash-title">LED ÎßàÏä§ÌÅ¨ Ïä§ÌÇ®ÏºÄÏñ¥<br>Îâ¥Ìä∏Î¶¨Ïñ¥ÎìúÎ∞îÏù¥Ï†Ä</h1>
            <div class="splash-sub">Premium Home Care Solution</div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï Î™®Îã¨ -->
    <div id="profile-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 24px; padding: 32px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 700;">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h2>
                <div style="display: flex; gap: 8px;">
                    <button onclick="openUserSelectModal()"
                        style="padding: 6px 12px; background: #F3F4F6; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; color: #4B5563;">
                        <i class="ph-bold ph-users"></i> ÏÇ¨Ïö©Ïûê Ï†ÑÌôò
                    </button>
                    <button onclick="closeProfileModal()"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: #9CA3AF;">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>
            </div>



            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Ïù¥Î¶Ñ
                    *</label>
                <input type="text" id="profile-name" placeholder="ÌôçÍ∏∏Îèô"
                    style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 14px; outline: none;">
            </div>

            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-main);">ÏÑ±Î≥Ñ</label>
                <div style="display: flex; gap: 10px;">
                    <label
                        style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; border: 1px solid #E5E7EB; border-radius: 12px; cursor: pointer;">
                        <input type="radio" name="gender" value="female" style="accent-color: var(--primary);"> Ïó¨ÏÑ±
                    </label>
                    <label
                        style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; border: 1px solid #E5E7EB; border-radius: 12px; cursor: pointer;">
                        <input type="radio" name="gender" value="male" style="accent-color: var(--primary);"> ÎÇ®ÏÑ±
                    </label>
                </div>
            </div>

            <div class="input-group">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">ÌîºÎ∂Ä
                    ÌÉÄÏûÖ</label>
                <select id="profile-skin-type"
                    style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 14px; outline: none; background: white;">
                    <option value="ÏßÄÏÑ±">ÏßÄÏÑ±</option>
                    <option value="Í±¥ÏÑ±">Í±¥ÏÑ±</option>
                    <option value="Ï§ëÏÑ±">Ï§ëÏÑ±</option>
                    <option value="Î≥µÌï©ÏÑ±">Î≥µÌï©ÏÑ±</option>
                    <option value="ÎØºÍ∞êÏÑ±">ÎØºÍ∞êÏÑ±</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">ÌîºÎ∂Ä Í≥†ÎØº
                    (Ïó¨Îü¨ Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <label class="concern-chip" data-concern="Ï£ºÎ¶Ñ"
                        style="display: inline-flex; align-items: center; padding: 8px 12px; background: #F3F4F6; border-radius: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" value="Ï£ºÎ¶Ñ" style="margin-right: 6px; display: none;"> Ï£ºÎ¶Ñ
                    </label>
                    <label class="concern-chip" data-concern="ÏÉâÏÜåÏπ®Ï∞©"
                        style="display: inline-flex; align-items: center; padding: 8px 12px; background: #F3F4F6; border-radius: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" value="ÏÉâÏÜåÏπ®Ï∞©" style="margin-right: 6px; display: none;"> ÏÉâÏÜåÏπ®Ï∞©
                    </label>
                    <label class="concern-chip" data-concern="Î™®Í≥µ"
                        style="display: inline-flex; align-items: center; padding: 8px 12px; background: #F3F4F6; border-radius: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" value="Î™®Í≥µ" style="margin-right: 6px; display: none;"> Î™®Í≥µ
                    </label>
                    <label class="concern-chip" data-concern="ÌÉÑÎ†•"
                        style="display: inline-flex; align-items: center; padding: 8px 12px; background: #F3F4F6; border-radius: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" value="ÌÉÑÎ†•" style="margin-right: 6px; display: none;"> ÌÉÑÎ†•
                    </label>
                    <label class="concern-chip" data-concern="Ïó¨ÎìúÎ¶Ñ"
                        style="display: inline-flex; align-items: center; padding: 8px 12px; background: #F3F4F6; border-radius: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" value="Ïó¨ÎìúÎ¶Ñ" style="margin-right: 6px; display: none;"> Ïó¨ÎìúÎ¶Ñ
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Í¥ÄÎ¶¨
                    Î™©Ìëú</label>
                <textarea id="profile-goals" placeholder="ÏõêÌïòÎäî ÌîºÎ∂Ä ÏÉÅÌÉúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                    style="width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 14px; outline: none; resize: vertical; min-height: 80px;"></textarea>
            </div>

            <button onclick="saveProfile()" class="btn-primary"
                style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                <i class="ph-bold ph-check"></i> Ï†ÄÏû•ÌïòÍ∏∞
            </button>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="ph-fill ph-plant" style="color:var(--primary);"></i>
                NutriAdvisor <span class="badge-pro">PRO</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button onclick="openProfileModal()"
                    style="background: #E5E7EB; border: none; padding: 8px 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: #374151;">
                    <i class="ph-fill ph-user-circle" style="font-size: 16px;"></i>
                    <span id="header-username">ÏÇ¨Ïö©Ïûê</span>
                </button>
                <div class="status-pill" id="ble-btn-header" onclick="toggleBle()">
                    <div class="status-dot"></div>
                    <span id="ble-text-header">Connect</span>
                </div>
            </div>
        </header>

        <div id="tab-home" class="tab-content active">
            <div class="welcome-banner">
                <h2 style="margin:0 0 8px 0; font-size: 24px;">Î∞òÍ∞ëÏäµÎãàÎã§, <span id="welcome-username">ÏÇ¨Ïö©Ïûê</span>Îãò</h2>
                <p style="margin:0; opacity:0.9; font-size: 14px;">Ïò§ÎäòÏùò ÌîºÎ∂Ä Ïª®ÎîîÏÖòÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.</p>
            </div>

            <div class="section-title">Îπ†Î•∏ Ïã§Ìñâ</div>
            <div class="quick-actions">
                <div class="action-btn" onclick="switchTab('device')">
                    <div class="action-icon-circle"><i class="ph-fill ph-power"></i></div>
                    <div style="font-weight:700; margin-bottom:4px;">Îπ†Î•∏ ÏãúÏûë</div>
                    <div style="font-size:12px; color:#666;">Î∂ÑÏÑù ÏóÜÏù¥ ÏºúÍ∏∞</div>
                </div>
                <div class="action-btn primary" onclick="startAnalysis()">
                    <div class="action-icon-circle"><i class="ph-fill ph-scan"></i></div>
                    <div style="font-weight:700; margin-bottom:4px;">AI Ïä§ÎßàÌä∏ ÏºÄÏñ¥</div>
                    <div style="font-size:12px; color:#065F46;">Ï∏°Ï†ï ÌõÑ ÎßûÏ∂§ ÏÑ§Ï†ï</div>
                </div>
            </div>

            <div class="section-title"><i class="ph-fill ph-star" style="color:#F59E0B"></i> Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú ÏΩîÏä§</div>
            <div class="h-scroll">
                <div class="course-item" onclick="applyCourse('red', 15, 'ÌÉÑÎ†•/Ï£ºÎ¶Ñ')">
                    <div class="course-dot" style="background:#EF4444;"></div>
                    <div style="font-size:24px; margin-bottom:8px; color:var(--text-main);">
                        <i class="ph-fill ph-flower"></i>
                    </div>
                    <div style="font-weight:700; font-size:14px;">ÌÉÑÎ†•/Ï£ºÎ¶Ñ</div>
                    <div style="font-size:11px; color:#666;">Red ¬∑ 15Î∂Ñ</div>
                </div>
                <div class="course-item" onclick="applyCourse('blue', 20, 'Î™®Í≥µ/ÏßÑÏ†ï')">
                    <div class="course-dot" style="background:#3B82F6;"></div>
                    <div style="font-size:24px; margin-bottom:8px; color:var(--text-main);">
                        <i class="ph-fill ph-drop"></i>
                    </div>
                    <div style="font-weight:700; font-size:14px;">Î™®Í≥µ/ÏßÑÏ†ï</div>
                    <div style="font-size:11px; color:#666;">Blue ¬∑ 20Î∂Ñ</div>
                </div>
                <div class="course-item" onclick="applyCourse('gold', 15, 'ÎØ∏Î∞±/ÌÜ§ÏóÖ')">
                    <div class="course-dot" style="background:#F59E0B;"></div>
                    <div style="font-size:24px; margin-bottom:8px; color:var(--text-main);">
                        <i class="ph-fill ph-sparkle"></i>
                    </div>
                    <div style="font-weight:700; font-size:14px;">ÎØ∏Î∞±/ÌÜ§ÏóÖ</div>
                    <div style="font-size:11px; color:#666;">Gold ¬∑ 15Î∂Ñ</div>
                </div>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div id="analysis-cam">
                <div class="section-title">ÌîºÎ∂Ä Ï¥¨ÏòÅ</div>

                <div class="camera-frame">
                    <div class="face-guide-overlay" id="face-guide-overlay" style="display:none;">
                        <div
                            style="color:white; font-size:12px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:8px;">
                            Ïù¥Îßà</div>
                        <div style="display:flex; width:100%; justify-content:space-between; padding:0 30px;">
                            <span
                                style="color:white; font-size:12px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:8px;">ÎààÍ∞Ä</span>
                            <span
                                style="color:white; font-size:12px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:8px;">ÎààÍ∞Ä</span>
                        </div>
                        <div
                            style="color:white; font-size:12px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:8px; margin-top:100px;">
                            ÌÑ±</div>
                    </div>

                    <img id="preview-img" style="width:100%; height:100%; object-fit:cover; display:none;">

                    <div id="cam-guide" style="text-align:center; color:#999;">
                        <i class="ph ph-camera" style="font-size:48px; margin-bottom:8px; opacity:0.5;"></i>
                        <p style="margin:0;">Ïπ¥Î©îÎùº ÎòêÎäî Ïï®Î≤îÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                    </div>
                </div>

                <div id="btn-group-init" class="btn-row">
                    <button class="btn-half btn-outline" onclick="triggerGallery()">
                        <i class="ph-bold ph-image"></i> Ïï®Î≤î ÏÑ†ÌÉù
                    </button>
                    <button class="btn-half btn-primary" onclick="startCamera()">
                        <i class="ph-bold ph-camera"></i> Ïπ¥Î©îÎùº Ï¥¨ÏòÅ
                    </button>
                </div>

                <div id="btn-group-capture" style="display:none; text-align:center; margin-bottom:24px;">
                    <button class="btn-capture" onclick="captureCamera()"></button>
                    <div style="margin-top:8px; font-size:12px; color:#666;">Ï¥¨ÏòÅÌïòÎ†§Î©¥ ÎàÑÎ•¥ÏÑ∏Ïöî</div>
                </div>

                <div id="btn-group-confirm" class="btn-row" style="display:none;">
                    <button class="btn-half btn-outline" onclick="changePhoto()">
                        <i class="ph-bold ph-images"></i> ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω
                    </button>
                    <button class="btn-half btn-dark" onclick="runAi()">
                        <i class="ph-bold ph-lightning"></i> AI Î∂ÑÏÑù Ïã§Ìñâ
                    </button>
                </div>

                <input type="file" id="file-input" style="display:none;" accept="image/*" onchange="handleFile(this)">
            </div>

            <div id="analysis-result" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div class="section-title" style="margin:0;">ÏñºÍµ¥ ÌîºÎ∂Ä Ï†ïÎ∞Ä Î∂ÑÏÑù</div>
                    <button onclick="reanalyze()"
                        style="padding:8px 16px; background:#F3F4F6; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; color:#4B5563; display:flex; align-items:center; gap:6px;">
                        <i class="ph-bold ph-camera-rotate"></i> Ïû¨Î∂ÑÏÑù
                    </button>
                </div>

                <div class="face-map-container">
                    <img id="result-face-img" class="face-map-img" src="" alt="Face">
                </div>

                <div style="text-align:center; margin-bottom:20px; margin-top: 10px;">
                    <div style="font-size:13px; color:#666;">Ï¢ÖÌï© ÌîºÎ∂Ä Ï†êÏàò</div>
                    <div id="score-display"
                        style="font-size:42px; font-weight:800; color:var(--primary); line-height:1;">-</div>
                </div>

                <div class="chart-box"><canvas id="radarChart"></canvas></div>

                <div class="section-title">
                    <i class="ph-fill ph-magnifying-glass-plus" style="color:#6366F1"></i> ÏÉÅÏÑ∏ ÌîºÎ∂Ä Î∂ÑÏÑù
                </div>
                <div id="detailed-metrics" class="card" style="display:none;">
                    <div style="font-size:13px; color:#666; margin-bottom:12px;">Ï£ºÏöî ÌîºÎ∂Ä ÏßÄÌëú (AI Î∂ÑÏÑù)</div>
                    <div id="metrics-content"
                        style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;"></div>
                    <button onclick="toggleMetrics()"
                        style="width:100%; padding:10px; background:#F3F4F6; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; color:#4B5563;">
                        <span id="toggle-text">Ï†ëÍ∏∞</span> <i class="ph-bold ph-caret-up"></i>
                    </button>
                </div>

                <div class="section-title">AI ÎßûÏ∂§ ÏÜîÎ£®ÏÖò</div>
                <div class="solution-card">
                    <div style="font-size:32px; color:var(--primary-dark);">
                        <i class="ph-fill ph-flower"></i>
                    </div>
                    <div>
                        <div style="font-weight:700; font-size:16px;">ÌÉÑÎ†• ÏßëÏ§ë ÏΩîÏä§</div>
                        <div style="font-size:13px; color:#666;">ÎààÍ∞ÄÏôÄ Î≥º Î∂ÄÏúÑ ÏßëÏ§ë ÏºÄÏñ¥ ÌïÑÏöî</div>
                    </div>
                </div>
                <button class="btn-green" onclick="applyCourse('red', 15, 'ÌÉÑÎ†• ÏßëÏ§ë ÏΩîÏä§')">ÏÜîÎ£®ÏÖò ÎîîÎ∞îÏù¥Ïä§ Ï†ÑÏÜ° <i
                        class="ph-bold ph-arrow-right"></i></button>
            </div>
        </div>

        <div id="tab-device" class="tab-content">
            <div class="section-title">Í∏∞Í∏∞ Í¥ÄÎ¶¨</div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:700; font-size:16px; margin-bottom:4px;">LED Mask ÏÉÅÌÉú</div>
                    <div id="device-tab-status" style="font-size:13px; color:#666;">Ïó∞Í≤∞Îêú Í∏∞Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                </div>
                <button id="ble-btn-device" onclick="toggleBle()"
                    style="padding:10px 16px; background:#F3F4F6; border:none; border-radius:12px; font-weight:600; color:#1F2937; cursor:pointer;">
                    <i class="ph-bold ph-bluetooth-connect"></i> Í∏∞Í∏∞ Ï∞æÍ∏∞
                </button>
            </div>

            <div class="section-title">ÏàòÎèô Ï†úÏñ¥</div>
            <div class="card">
                <div style="text-align:center; margin-bottom:24px;">
                    <div class="mask-visual" id="mask-visual"></div>
                    <h3 id="device-title" style="margin:0;">Custom Mode</h3>
                    <p id="device-subtitle" style="margin:5px 0 16px 0; color:#666; font-size:13px;">Ready to start</p>

                    <button id="btn-power" class="btn-dark" onclick="togglePower()" style="margin-bottom: 20px;">
                        <i class="ph-bold ph-power"></i> Start Therapy
                    </button>

                    <div id="loop-status-bar" style="display:none; margin-top: 10px;">
                        <div
                            style="font-size:12px; color:#666; margin-bottom:8px; display:flex; justify-content:space-between;">
                            <span id="loop-step-text" style="font-weight:600;">Step 1: Red Mode</span>
                            <span id="loop-timer-text">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 5:00</span>
                        </div>
                        <div style="width:100%; height:8px; background:#E5E7EB; border-radius:4px; overflow:hidden;">
                            <div id="loop-progress"
                                style="width:0%; height:100%; background:var(--primary); transition:width 1s linear; border-radius:4px;">
                            </div>
                        </div>
                    </div>
                </div>

                <label style="font-size:13px; font-weight:600; color:#666; display:block; margin-bottom:10px;">LED
                    MODE</label>
                <div class="mode-toggles">
                    <div class="mode-btn active" id="mode-red" onclick="setMode('red')">
                        <div class="dot" style="background:#EF4444;"></div> Red
                    </div>
                    <div class="mode-btn" id="mode-blue" onclick="setMode('blue')">
                        <div class="dot" style="background:#3B82F6;"></div> Blue
                    </div>
                    <div class="mode-btn" id="mode-gold" onclick="setMode('gold')">
                        <div class="dot" style="background:#F59E0B;"></div> Gold
                    </div>
                </div>

                <label
                    style="font-size:13px; font-weight:600; color:#666; display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>DURATION (ÏàòÎèô ÏÑ§Ï†ï Ïãú)</span> <span id="time-val" style="color:var(--primary);">15 min</span>
                </label>
                <input type="range" id="time-slider" min="5" max="30" step="5" value="15"
                    oninput="updateTime(this.value)">
            </div>

            <div class="section-title">
                <i class="ph-fill ph-arrows-clockwise" style="color:#8B5CF6"></i> ÌîÑÎ¶¨ÎØ∏ÏóÑ ÏàúÌôò ÏºÄÏñ¥ (Ï¥à Îã®ÏúÑ)
            </div>
            <div class="h-scroll" style="margin-bottom:24px;">
                <div class="course-item" onclick="startLoopCourse('full_care')" style="min-width:160px;">
                    <div class="course-dot" style="background:linear-gradient(90deg, #EF4444, #3B82F6, #F59E0B);"></div>
                    <div style="font-size:24px; margin-bottom:8px; color:var(--text-main);">
                        <i class="ph-fill ph-magic-wand"></i>
                    </div>
                    <div style="font-weight:700; font-size:14px;">3Ï¥à Í∞ÑÍ≤© ÌíÄ ÏºÄÏñ¥</div>
                    <div style="font-size:11px; color:#666;">R(3s)‚ÜíB(3s)‚ÜíG(3s) ¬∑ 15Î∂Ñ</div>
                </div>

                <div class="course-item" onclick="startLoopCourse('acne_care')" style="min-width:160px;">
                    <div class="course-dot" style="background:linear-gradient(90deg, #3B82F6, #EF4444);"></div>
                    <div style="font-size:24px; margin-bottom:8px; color:var(--text-main);">
                        <i class="ph-fill ph-shield-check"></i>
                    </div>
                    <div style="font-weight:700; font-size:14px;">5Ï¥à Í∞ÑÍ≤© Ìä∏Îü¨Î∏î</div>
                    <div style="font-size:11px; color:#666;">B(5s)‚ÜíR(5s) ¬∑ 15Î∂Ñ</div>
                </div>
            </div>

            <div class="section-title">Îπ†Î•∏ ÏãúÎÇòÎ¶¨Ïò§ (Îã®Ïùº Î™®Îìú)</div>
            <div class="h-scroll" style="margin-bottom:20px;">
                <div class="preset-chip" onclick="applyCourse('red', 5, 'Î™®Îãù ÏºÄÏñ¥')">
                    <span class="preset-icon"><i class="ph-fill ph-sun"></i></span>
                    <div style="font-weight:700; font-size:13px;">Î™®Îãù ÏºÄÏñ¥</div>
                    <div style="font-size:10px; color:#666;">Red 5Î∂Ñ</div>
                </div>
                <div class="preset-chip" onclick="applyCourse('blue', 20, 'Ìä∏Îü¨Î∏î ÏßÑÏ†ï')">
                    <span class="preset-icon"><i class="ph-fill ph-drop"></i></span>
                    <div style="font-weight:700; font-size:13px;">Ìä∏Îü¨Î∏î ÏßÑÏ†ï</div>
                    <div style="font-size:10px; color:#666;">Blue 20Î∂Ñ</div>
                </div>
                <div class="preset-chip" onclick="applyCourse('gold', 15, 'ÎÇòÏù¥Ìä∏ Î¶¨ÌéòÏñ¥')">
                    <span class="preset-icon"><i class="ph-fill ph-moon-stars"></i></span>
                    <div style="font-weight:700; font-size:13px;">ÎÇòÏù¥Ìä∏ Î¶¨ÌéòÏñ¥</div>
                    <div style="font-size:10px; color:#666;">Gold 15Î∂Ñ</div>
                </div>
                <div class="preset-chip" onclick="applyCourse('red', 20, 'ÏßëÏ§ë ÌÉÑÎ†•')">
                    <span class="preset-icon"><i class="ph-fill ph-activity"></i></span>
                    <div style="font-weight:700; font-size:13px;">ÏßëÏ§ë ÌÉÑÎ†•</div>
                    <div style="font-size:10px; color:#666;">Red 20Î∂Ñ</div>
                </div>
            </div>
        </div>

        <div id="tab-history" class="tab-content">
            <div class="section-title">ÌîºÎ∂Ä Î≥ÄÌôî Î¶¨Ìè¨Ìä∏</div>
            <div class="card" style="height:250px;"><canvas id="lineChart"></canvas></div>
            <div class="section-title">ÏµúÍ∑º Í∏∞Î°ù</div>
            <div id="history-list"></div>
        </div>

        <div id="tab-chatbot" class="tab-content">
            <div class="section-title">
                <i class="ph-fill ph-plant" style="color:var(--primary);"></i> AI ÌîºÎ∂Ä ÏÉÅÎã¥
            </div>

            <div id="chat-container" style="display:flex; flex-direction:column; height: calc(100vh - 180px);">
                <div id="chat-box" style="flex:1; overflow-y:auto; padding-bottom:20px;">
                    <!-- Welcome Message -->
                    <div style="display:flex; align-items:flex-start; margin-bottom:16px;">
                        <div
                            style="width:32px; height:32px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid #E5E7EB; margin-right:8px; flex-shrink:0;">
                            <i class="ph-fill ph-plant" style="color:var(--primary); font-size:18px;"></i>
                        </div>
                        <div
                            style="background:white; padding:12px 16px; border-radius:16px; border-bottom-left-radius:4px; max-width:85%; border:1px solid #E5E7EB; color:var(--text-main); font-size:15px; line-height:1.5;">
                            ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌîºÎ∂Ä Í≥†ÎØºÏóê ÎåÄÌï¥ Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî.<br><br>
                            üì∑ ÏÇ¨ÏßÑÏùÑ Ìï®Íªò Î≥¥ÎÇ¥Ï£ºÏãúÎ©¥ Îçî Ï†ïÌôïÌïú ÏÉÅÎã¥Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.
                        </div>
                    </div>
                </div>

                <!-- Image Preview Area -->
                <div id="chat-image-preview-container"
                    style="display:none; padding: 10px; background: #f9fafb; border-top: 1px solid #e5e7eb; align-items: center; gap: 10px;">
                    <img id="chat-preview-img" style="height: 50px; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-size: 12px; color: #666; flex: 1;">ÏÇ¨ÏßÑ Ï≤®Î∂ÄÎê®</span>
                    <button onclick="cancelImageUpload()"
                        style="background: none; border: none; padding: 4px; cursor: pointer; color: #ef4444;">
                        <i class="ph-bold ph-x-circle" style="font-size: 20px;"></i>
                    </button>
                </div>

                <!-- Input Area -->
                <div style="padding:10px 0; background:var(--bg-page);">
                    <div
                        style="display:flex; gap:8px; align-items:center; background:white; padding:8px; border-radius:24px; border:1px solid #E5E7EB; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <label for="chat-image-input"
                            style="padding:8px; cursor:pointer; color:#9CA3AF; display:flex; align-items:center;">
                            <i class="ph-bold ph-image" style="font-size:24px;"></i>
                        </label>
                        <input type="file" id="chat-image-input" accept="image/*" style="display:none;"
                            onchange="handleImageUpload(this)">

                        <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                            style="flex:1; border:none; outline:none; font-size:15px; background:transparent;"
                            onkeypress="if(event.key === 'Enter') sendChatMessage()">

                        <button onclick="sendChatMessage()"
                            style="width:36px; height:36px; border-radius:50%; background:var(--primary); border:none; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
                            <i class="ph-bold ph-paper-plane-right" style="font-size:18px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="switchTab('home')"><i class="ph-fill ph-house"></i> Ìôà</button>
            <button class="nav-item" onclick="switchTab('analysis')"><i class="ph-bold ph-scan"></i> Î∂ÑÏÑù</button>
            <button class="nav-item" onclick="switchTab('device')"><i class="ph-bold ph-sliders-horizontal"></i>
                ÎîîÎ∞îÏù¥Ïä§</button>
            <button class="nav-item" onclick="switchTab('history')"><i class="ph-bold ph-clock-counter-clockwise"></i>
                Í∏∞Î°ù</button>
            <button class="nav-item" onclick="switchTab('chatbot')"><i class="ph-bold ph-chat-circle-dots"></i>
                ÏÉÅÎã¥</button>
        </nav>
    </div>

    <!-- ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù Î™®Îã¨ (Body Level) -->
    <div id="user-select-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 11000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 24px; padding: 32px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 700;">ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù</h2>
                <button onclick="closeUserSelectModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: #9CA3AF;">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>

            <div id="user-list" style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px;">
                <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê©ÎãàÎã§ -->
            </div>

            <button onclick="createNewUser()" class="btn-outline"
                style="width: 100%; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="ph-bold ph-plus"></i> ÏÉà ÏÇ¨Ïö©Ïûê ÎßåÎì§Í∏∞
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // 1. Splash & Init
        // ============================================
        document.addEventListener("DOMContentLoaded", function () {
            // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Î°úÎìú (ÎπÑÎèôÍ∏∞ Ìò∏Ï∂ú)
            loadUserProfile();

            // BLE ÏÉÅÌÉú ÌôïÏù∏ (ÎπÑÎèôÍ∏∞ Ìò∏Ï∂ú)
            checkBleStatus();

            // 1. Ï†ïÏÉÅÏ†ÅÏù∏ Ï†úÍ±∞ ÌÉÄÏù¥Î®∏ (2Ï¥à ÌõÑ)
            setTimeout(() => {
                removeSplashScreen();
            }, 2000);

            // 2. ÏïàÏ†ÑÏû•Ïπò: ÌòπÏãúÎùºÎèÑ 2Ï¥à ÌÉÄÏù¥Î®∏Í∞Ä Ïã§Ìå®Ìï† Í≤ΩÏö∞Î•º ÎåÄÎπÑÌï¥ 5Ï¥à ÌõÑ Í∞ïÏ†ú Ï†úÍ±∞
            setTimeout(() => {
                removeSplashScreen();
            }, 5000);
        });

        function removeSplashScreen() {
            const splash = document.getElementById('splash-screen');
            if (splash && !splash.classList.contains('hidden')) {
                splash.classList.add('hidden');
                setTimeout(() => { splash.style.display = 'none'; }, 600);
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = 'ph-info';
            if (type === 'success') icon = 'ph-check-circle';
            if (type === 'error') icon = 'ph-warning-circle';
            toast.innerHTML = `<i class="ph-fill ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.4s forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        const CONFIG = {
            API_BASE_URL: '',
            USER_ID: localStorage.getItem('myskin_user_id') || 'user_' + Math.random().toString(36).substr(2, 9)
        };

        // USER_IDÎ•º localStorageÏóê Ï†ÄÏû•
        if (!localStorage.getItem('myskin_user_id')) {
            localStorage.setItem('myskin_user_id', CONFIG.USER_ID);
        }

        // ============================================
        // ÌîÑÎ°úÌïÑ Í¥ÄÎ¶¨ Ìï®Ïàò
        // ============================================
        async function loadUserProfile() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/user/profile/${CONFIG.USER_ID}`);

                if (response.ok) {
                    const data = await response.json();
                    const profile = data.profile;

                    if (profile && profile.name) {
                        // Ìó§ÎçîÏôÄ ÌôòÏòÅ Î∞∞ÎÑà ÏóÖÎç∞Ïù¥Ìä∏
                        document.getElementById('header-username').textContent = profile.name;
                        document.getElementById('welcome-username').textContent = profile.name;

                        // localStorageÏóê Ïù¥Î¶Ñ Ï†ÄÏû•
                        localStorage.setItem('myskin_username', profile.name);
                    }
                } else {
                    // ÌîÑÎ°úÌïÑÏù¥ ÏóÜÏúºÎ©¥ localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
                    const savedName = localStorage.getItem('myskin_username');
                    if (savedName) {
                        document.getElementById('header-username').textContent = savedName;
                        document.getElementById('welcome-username').textContent = savedName;
                    }
                }
            } catch (error) {
                console.log('ÌîÑÎ°úÌïÑ Î°úÎìú Ïã§Ìå®:', error);
                // Ïò§Î•ò Ïãú localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
                const savedName = localStorage.getItem('myskin_username');
                if (savedName) {
                    document.getElementById('header-username').textContent = savedName;
                    document.getElementById('welcome-username').textContent = savedName;
                }
            }
        }

        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'flex';

            // Í∏∞Ï°¥ ÌîÑÎ°úÌïÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadProfileToModal();
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        async function loadProfileToModal() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/user/profile/${CONFIG.USER_ID}`);
                const data = await response.json();
                if (data.success) {
                    const p = data.profile;
                    document.getElementById('profile-name').value = p.name || '';
                    document.getElementById('profile-skin-type').value = p.skin_type || 'ÏßÄÏÑ±';
                    document.getElementById('profile-goals').value = p.goals || '';

                    if (p.gender) {
                        const genderRadio = document.querySelector(`input[name="gender"][value="${p.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }

                    document.querySelectorAll('.concern-chip').forEach(chip => {
                        chip.classList.toggle('active', p.concerns?.includes(chip.dataset.concern));
                    });
                }
            } catch (err) {
                console.error('Failed to fetch profile:', err);
            }
        }

        // ============================================
        // ÏÇ¨Ïö©Ïûê Ï†ÑÌôò Í∏∞Îä•
        // ============================================
        function openUserSelectModal() {
            closeProfileModal(); // ÌîÑÎ°úÌïÑ Î™®Îã¨ Îã´Í∏∞
            document.getElementById('user-select-modal').style.display = 'flex';
            loadUserList();
        }

        function closeUserSelectModal() {
            document.getElementById('user-select-modal').style.display = 'none';
        }

        async function loadUserList() {
            const listContainer = document.getElementById('user-list');
            listContainer.innerHTML = '<div style="text-align:center; padding:20px;">Î°úÎî© Ï§ë...</div>';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/users`);
                if (response.ok) {
                    const data = await response.json();
                    const users = data.users || [];

                    if (users.length === 0) {
                        listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                        return;
                    }

                    listContainer.innerHTML = users.map(user => {
                        const isCurrent = user.user_id === CONFIG.USER_ID;
                        const bgColor = isCurrent ? '#ECFDF5' : '#F9FAFB';
                        const borderColor = isCurrent ? 'var(--primary)' : '#E5E7EB';

                        // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÎÇò Í∏∞Î≥∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏïÑÎãàÎ©¥ ÏÇ≠Ï†ú Î≤ÑÌäº ÌëúÏãú
                        const canDelete = !isCurrent;

                        return `
                        <div style="background:${bgColor}; border:1px solid ${borderColor}; padding:10px 16px; border-radius:16px; display:flex; align-items:center; justify-content:space-between; transition:0.2s;">
                            <div onclick="selectUser('${user.user_id}', '${user.name}')" style="flex:1; display:flex; align-items:center; gap:12px; cursor:pointer;">
                                <div style="width:40px; height:40px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid #E5E7EB; color:#4B5563;">
                                    <i class="ph-fill ph-user"></i>
                                </div>
                                <div>
                                    <div style="font-weight:700; font-size:15px; color:#1F2937;">${user.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</div>
                                    <div style="font-size:12px; color:#6B7280;">ÏµúÍ∑º Ï†ëÏÜç: ${new Date(user.created_at).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                ${isCurrent ? '<i class="ph-bold ph-check" style="color:var(--primary); font-size:20px; margin-right:8px;"></i>' : ''}
                                ${canDelete ? `
                                <button onclick="deleteUser('${user.user_id}', '${user.name}')" style="padding:8px; border:none; background:#FEE2E2; color:#EF4444; border-radius:8px; cursor:pointer;">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error("ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïò§Î•ò:", error);
                listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>';
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`Ï†ïÎßêÎ°ú '${userName}' ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\\nÎ™®Îì† Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÎ©∞ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/user/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadUserList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showToast('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Ïã§Ìå®', 'error');
                }
            } catch (error) {
                console.error("ÏÇ≠Ï†ú Ïò§Î•ò:", error);
                showToast('Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        }

        function selectUser(userId, userName) {
            if (userId === CONFIG.USER_ID) {
                closeUserSelectModal();
                return;
            }

            CONFIG.USER_ID = userId;
            localStorage.setItem('myskin_user_id', userId);

            if (userName) {
                localStorage.setItem('myskin_username', userName);
                document.getElementById('header-username').textContent = userName;
                document.getElementById('welcome-username').textContent = userName;
            }

            // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
            loadUserProfile();

            // ÌûàÏä§ÌÜ†Î¶¨ Îì± Îã§Î•∏ Îç∞Ïù¥ÌÑ∞ÎèÑ ÌïÑÏöîÌïòÎ©¥ Î¶¨Î°úÎìú
            // Ïòà: renderHistory(); 
            // ÌòÑÏû¨ Íµ¨Ï°∞ÏÉÅ ÌÉ≠ Ï†ÑÌôò Ïãú Î°úÎìúÎêòÎØÄÎ°ú Í∞ïÏ†ú Î¶¨Î°úÎìú Î∂àÌïÑÏöîÌï† Ïàò ÏûàÏùå

            closeUserSelectModal();
            showToast(`${userName}ÎãòÏúºÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§`, 'success');
        }

        function createNewUser() {
            const newId = 'user_' + Math.random().toString(36).substr(2, 9);
            CONFIG.USER_ID = newId;
            localStorage.setItem('myskin_user_id', newId);
            localStorage.removeItem('myskin_username'); // Ïù¥Î¶Ñ Ï¥àÍ∏∞Ìôî

            // UI Ï¥àÍ∏∞Ìôî
            document.getElementById('header-username').textContent = 'ÏÉà ÏÇ¨Ïö©Ïûê';
            document.getElementById('welcome-username').textContent = 'ÏÉà ÏÇ¨Ïö©Ïûê';

            closeUserSelectModal();
            openProfileModal(); // Î∞îÎ°ú ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï Ïú†ÎèÑ

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-skin-type').value = '';
            document.getElementById('profile-goals').value = '';
            document.querySelectorAll('#profile-modal input[type="checkbox"]').forEach(cb => cb.checked = false);

            showToast('ÏÉà ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. ÌîÑÎ°úÌïÑÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'info');
        }

        async function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();

            if (!name) {
                showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }

            try {
                const checkedGender = document.querySelector('input[name="gender"]:checked');
                const profileData = {
                    user_id: CONFIG.USER_ID,
                    name: document.getElementById('profile-name').value,
                    gender: checkedGender ? checkedGender.value : null,
                    skin_type: document.getElementById('profile-skin-type').value,
                    concerns: Array.from(document.querySelectorAll('.concern-chip.active')).map(el => el.dataset.concern),
                    goals: document.getElementById('profile-goals').value
                };

                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/user/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    const data = await response.json();

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('header-username').textContent = name;
                    document.getElementById('welcome-username').textContent = name;

                    // localStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('myskin_username', name);

                    closeProfileModal();
                    showToast('ÌîÑÎ°úÌïÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                } else {
                    showToast('ÌîÑÎ°úÌïÑ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                }
            } catch (error) {
                console.error('ÌîÑÎ°úÌïÑ Ï†ÄÏû• Ïò§Î•ò:', error);
                showToast('ÌîÑÎ°úÌïÑ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        }

        // ============================================
        // 2. State & Constants
        // ============================================
        let state = {
            connected: false, bleDeviceName: '', power: false,
            mode: 'red', wavelength: 630, time: 15, intensity: 75,
            cameraStream: null, capturedImage: null, history: [],

            // Loop Í∏∞Îä• ÏÉÅÌÉú
            isLooping: false,
            loopQueue: [],
            currentLoopIndex: 0,
            loopTimerDetails: null
        };

        // [Ï§ëÏöî] Î£®ÌîÑ Ìå®ÌÑ¥ Ï†ïÏùò (sec: Ï¥à Îã®ÏúÑ ÏßÄÏÜç ÏãúÍ∞Ñ)
        // Ï¥ù 15Î∂Ñ(900Ï¥à) ÎèôÏïà Ïù¥ Ìå®ÌÑ¥Ïù¥ Í≥ÑÏÜç Î∞òÎ≥µÎê©ÎãàÎã§.
        const LOOP_PATTERNS = {
            'full_care': {
                totalMin: 15,
                steps: [
                    { mode: 'red', sec: 3, name: 'RED (3s)' },
                    { mode: 'blue', sec: 3, name: 'BLUE (3s)' },
                    { mode: 'gold', sec: 3, name: 'GOLD (3s)' }
                ]
            },
            'acne_care': {
                totalMin: 15,
                steps: [
                    { mode: 'blue', sec: 5, name: 'BLUE (5s)' },
                    { mode: 'red', sec: 5, name: 'RED (5s)' }
                ]
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            const targetTab = document.getElementById('tab-' + tabId);
            if (targetTab) targetTab.classList.add('active');

            const tabs = ['home', 'analysis', 'device', 'history'];
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[tabs.indexOf(tabId)]) navItems[tabs.indexOf(tabId)].classList.add('active');

            if (tabId === 'history') renderHistory();
            if (tabId === 'chatbot') {
                loadChatHistory();
                setTimeout(() => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, 100);
            }
            window.scrollTo(0, 0);
        }

        // ============================================
        // 4. Chatbot Logic
        // ============================================
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/v1/chatbot/history/${CONFIG.USER_ID}`);
                const history = await response.json();

                const chatBox = document.getElementById('chat-box');
                // Preserve welcome message if box is empty or just has welcome
                const welcomeMsg = chatBox.firstElementChild;
                chatBox.innerHTML = '';
                if (welcomeMsg) chatBox.appendChild(welcomeMsg);

                history.forEach(chat => {
                    renderMessage(chat.message, 'user', chat.image_path);
                    renderMessage(chat.reply, 'bot');
                });
            } catch (err) {
                console.error('Failed to load chat history:', err);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const imageInput = document.getElementById('chat-image-input');
            const imageFile = imageInput.files[0];

            if (!message && !imageFile) return;

            // Clear inputs
            input.value = '';
            document.getElementById('chat-image-preview-container').style.display = 'none';
            imageInput.value = ''; // Reset file input

            // Show user message
            let imageSrc = null;
            if (imageFile) {
                imageSrc = URL.createObjectURL(imageFile);
            }
            renderMessage(message, 'user', imageSrc);

            // Show loading
            renderLoading(true);

            try {
                const formData = new FormData();
                formData.append('user_id', CONFIG.USER_ID);
                formData.append('message', message);
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                // If user wants to attach current analysis photo (logic to be implemented if needed)
                // For now, we rely on manual upload.

                const response = await fetch('/api/v1/chatbot/chat', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Remove loading
                renderLoading(false);

                if (data.reply) {
                    renderMessage(data.reply, 'bot');
                } else if (data.error) {
                    renderMessage('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + data.error, 'bot');
                }

            } catch (error) {
                console.error('Chat error:', error);
                renderLoading(false);
                renderMessage('ÏÑúÎ≤Ñ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'bot');
            }
        }

        function renderMessage(text, sender, imageUrl = null) {
            const chatBox = document.getElementById('chat-box');

            const msgDiv = document.createElement('div');
            msgDiv.style.display = 'flex';
            msgDiv.style.flexDirection = 'column';
            msgDiv.style.alignItems = sender === 'user' ? 'flex-end' : 'flex-start';
            msgDiv.style.marginBottom = '16px';
            msgDiv.style.opacity = '0';
            msgDiv.style.animation = 'fadeUp 0.3s forwards';

            // Image display
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.maxWidth = '200px';
                img.style.borderRadius = '12px';
                img.style.marginBottom = '8px';
                img.style.border = '1px solid #E5E7EB';
                msgDiv.appendChild(img);
            }

            // Text bubble
            if (text) {
                const bubble = document.createElement('div');
                bubble.style.padding = '12px 16px';
                bubble.style.borderRadius = '16px';
                bubble.style.maxWidth = '85%';
                bubble.style.fontSize = '15px';
                bubble.style.lineHeight = '1.5';

                if (sender === 'user') {
                    bubble.style.background = 'var(--primary)';
                    bubble.style.color = 'white';
                    bubble.style.borderBottomRightRadius = '4px';
                } else {
                    bubble.style.background = 'white';
                    bubble.style.color = 'var(--text-main)';
                    bubble.style.border = '1px solid #E5E7EB';
                    bubble.style.borderBottomLeftRadius = '4px';
                    bubble.style.whiteSpace = 'pre-wrap'; // Preserve newlines
                }

                bubble.innerText = text;
                msgDiv.appendChild(bubble);
            }

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        let loadingInterval = null;

        function renderLoading(isLoading) {
            const chatBox = document.getElementById('chat-box');
            const existingLoader = document.getElementById('chat-loader');

            if (isLoading) {
                if (existingLoader) return;

                const loaderDiv = document.createElement('div');
                loaderDiv.id = 'chat-loader';
                loaderDiv.style.display = 'flex';
                loaderDiv.style.alignItems = 'center';
                loaderDiv.style.gap = '8px';
                loaderDiv.style.marginBottom = '16px';
                loaderDiv.style.color = '#6B7280';
                loaderDiv.style.fontSize = '12px';

                // Initial text
                const initialText = "AIÍ∞Ä ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±Ï§ëÏûÖÎãàÎã§...";

                loaderDiv.innerHTML = `
                    <div style="width:24px; height:24px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid #E5E7EB;">
                        <i class="ph-fill ph-plant" style="color:var(--primary);"></i>
                    </div>
                    <div class="typing-indicator" style="background:#F3F4F6; padding:8px 12px; border-radius:12px; display:flex; gap:4px;">
                        <span style="width:4px; height:4px; background:#9CA3AF; border-radius:50%; animation: bounce 1s infinite;"></span>
                        <span style="width:4px; height:4px; background:#9CA3AF; border-radius:50%; animation: bounce 1s infinite 0.2s;"></span>
                        <span style="width:4px; height:4px; background:#9CA3AF; border-radius:50%; animation: bounce 1s infinite 0.4s;"></span>
                    </div>
                    <span id="loading-text">${initialText}</span>
                `;

                chatBox.appendChild(loaderDiv);
                chatBox.scrollTop = chatBox.scrollHeight;

                // Dynamic text cycling
                const messages = [
                    "AIÍ∞Ä ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±Ï§ëÏûÖÎãàÎã§...",
                    "Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...",
                    "Ïó¥Ïã¨Ìûà ÎãµÎ≥ÄÏùÑ ÏûëÏÑ±ÌïòÍ≥† ÏûàÏñ¥Ïöî...",
                    "Í±∞Ïùò Îã§ ÎêòÏóàÏäµÎãàÎã§..."
                ];
                let msgIndex = 0;

                // Clear any existing interval just in case
                if (loadingInterval) clearInterval(loadingInterval);

                loadingInterval = setInterval(() => {
                    msgIndex = (msgIndex + 1) % messages.length;
                    const textSpan = document.getElementById('loading-text');
                    if (textSpan) {
                        textSpan.innerText = messages[msgIndex];
                    }
                }, 2000); // Change every 2 seconds

            } else {
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
                if (existingLoader) existingLoader.remove();
            }
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewContainer = document.getElementById('chat-image-preview-container');
                    const previewImg = document.getElementById('chat-preview-img');
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'flex';
                }
                reader.readAsDataURL(file);
            }
        }

        function cancelImageUpload() {
            document.getElementById('chat-image-input').value = '';
            document.getElementById('chat-image-preview-container').style.display = 'none';
        }

        // Add bounce animation style
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-4px); }
            }
        `;
        document.head.appendChild(styleSheet);
        // 3. BLE Logic (Web Bluetooth API ÏÇ¨Ïö©)
        // ============================================
        // BLE ÎîîÎ∞îÏù¥Ïä§ Î∞è ÌäπÏÑ± Ï†ÄÏû•
        let bleDevice = null;
        let bleCharacteristic = null;

        // ÏùºÎ∞òÏ†ÅÏù∏ BLE UART ÏÑúÎπÑÏä§ UUID Î™©Î°ù (Seeed Xiao Îì±ÏóêÏÑú ÏÇ¨Ïö©)
        const COMMON_SERVICE_UUIDS = [
            '0000ffe0-0000-1000-8000-00805f9b34fb',  // HM-10, Seeed Xiao Í∏∞Î≥∏
            '6e400001-b5a3-f393-e0a9-e50e24dcca9e',  // Nordic UART Service
            '0000fff0-0000-1000-8000-00805f9b34fb',  // ÏùºÎ∂Ä BLE Î™®Îìà
            '49535343-fe7d-4ae5-8fa9-9fafd205e455',  // Microchip BLE
        ];

        const COMMON_CHARACTERISTIC_UUIDS = [
            '0000ffe1-0000-1000-8000-00805f9b34fb',  // HM-10, Seeed Xiao Í∏∞Î≥∏ (TX/RX)
            '6e400002-b5a3-f393-e0a9-e50e24dcca9e',  // Nordic UART RX
            '6e400003-b5a3-f393-e0a9-e50e24dcca9e',  // Nordic UART TX
            '0000fff1-0000-1000-8000-00805f9b34fb',  // ÏùºÎ∂Ä BLE Î™®Îìà
            '49535343-1e4d-4bd9-ba61-23c647249616',  // Microchip TX
        ];

        async function checkBleStatus() {
            // Web BluetoothÎäî ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤ò ÏóÜÏù¥ ÏûêÎèô Ïó∞Í≤∞ Î∂àÍ∞Ä
            // Í∏∞Ï°¥ Ïó∞Í≤∞ ÏÉÅÌÉúÎßå ÌôïÏù∏
            if (bleDevice && bleDevice.gatt.connected) {
                state.connected = true;
                state.bleDeviceName = bleDevice.name || 'BLE ÎîîÎ∞îÏù¥Ïä§';
                updateBleStatus(true, state.bleDeviceName);
                console.log('BLE ÎîîÎ∞îÏù¥Ïä§ Ïù¥ÎØ∏ Ïó∞Í≤∞Îê®');
            } else {
                state.connected = false;
                updateBleStatus(false);
            }
        }

        async function toggleBle() {
            if (state.connected) {
                await disconnectBle();
            } else {
                await connectBle();
            }
        }

        async function connectBle() {
            try {
                // Web Bluetooth API ÏßÄÏõê ÌôïÏù∏
                if (!navigator.bluetooth) {
                    showToast('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî BluetoothÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§. ChromeÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }

                showToast('BLE ÎîîÎ∞îÏù¥Ïä§ Í≤ÄÏÉâ Ï§ë...', 'info');

                // Î™®Îì† BLE ÎîîÎ∞îÏù¥Ïä§ Í≤ÄÏÉâ ÌóàÏö© (acceptAllDevices)
                bleDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: COMMON_SERVICE_UUIDS
                });

                showToast('ÎîîÎ∞îÏù¥Ïä§ Ïó∞Í≤∞ Ï§ë...', 'info');
                console.log('ÏÑ†ÌÉùÎêú ÎîîÎ∞îÏù¥Ïä§:', bleDevice.name);

                // GATT ÏÑúÎ≤Ñ Ïó∞Í≤∞
                const server = await bleDevice.gatt.connect();

                // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏÑúÎπÑÏä§ ÏûêÎèô ÌÉêÏÉâ
                let service = null;
                for (const serviceUUID of COMMON_SERVICE_UUIDS) {
                    try {
                        service = await server.getPrimaryService(serviceUUID);
                        console.log('ÏÑúÎπÑÏä§ Î∞úÍ≤¨:', serviceUUID);
                        break;
                    } catch (e) {
                        continue;
                    }
                }

                if (!service) {
                    throw new Error('ÏßÄÏõêÎêòÎäî BLE ÏÑúÎπÑÏä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÌäπÏÑ± ÏûêÎèô ÌÉêÏÉâ
                for (const charUUID of COMMON_CHARACTERISTIC_UUIDS) {
                    try {
                        bleCharacteristic = await service.getCharacteristic(charUUID);
                        console.log('ÌäπÏÑ± Î∞úÍ≤¨:', charUUID);
                        break;
                    } catch (e) {
                        continue;
                    }
                }

                if (!bleCharacteristic) {
                    // ÌäπÏÑ±ÏùÑ Î™ª Ï∞æÏúºÎ©¥ ÏÑúÎπÑÏä§Ïùò Î™®Îì† ÌäπÏÑ± Ï§ë Ïì∞Í∏∞ Í∞ÄÎä•Ìïú Í≤É ÏÇ¨Ïö©
                    const characteristics = await service.getCharacteristics();
                    for (const char of characteristics) {
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            bleCharacteristic = char;
                            console.log('Ïì∞Í∏∞ Í∞ÄÎä•Ìïú ÌäπÏÑ± Î∞úÍ≤¨:', char.uuid);
                            break;
                        }
                    }
                }

                if (!bleCharacteristic) {
                    throw new Error('Ïì∞Í∏∞ Í∞ÄÎä•Ìïú BLE ÌäπÏÑ±ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                // Ïó∞Í≤∞ Ìï¥Ï†ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);

                state.connected = true;
                state.bleDeviceName = bleDevice.name || 'BLE ÎîîÎ∞îÏù¥Ïä§';
                updateBleStatus(true, state.bleDeviceName);
                showToast(`${state.bleDeviceName} Ïó∞Í≤∞ ÏÑ±Í≥µ!`, 'success');
                console.log('BLE Ïó∞Í≤∞ ÏôÑÎ£å:', bleDevice.name);

            } catch (error) {
                console.error('BLE Ïó∞Í≤∞ Ïò§Î•ò:', error);
                if (error.name === 'NotFoundError') {
                    showToast('ÎîîÎ∞îÏù¥Ïä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                } else if (error.name === 'SecurityError') {
                    showToast('Bluetooth Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                } else if (error.message.includes('User cancelled')) {
                    showToast('ÎîîÎ∞îÏù¥Ïä§ ÏÑ†ÌÉùÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'info');
                } else {
                    showToast('Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message, 'error');
                }
                state.connected = false;
                updateBleStatus(false);
            }
        }

        function onBleDisconnected(event) {
            console.log('BLE Ïó∞Í≤∞ Ìï¥Ï†úÎê®:', event.target.name);
            state.connected = false;
            state.bleDeviceName = '';
            bleDevice = null;
            bleCharacteristic = null;
            updateBleStatus(false);
            showToast('Í∏∞Í∏∞ Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        async function disconnectBle() {
            try {
                // Ïó∞Í≤∞ Ìï¥Ï†ú Ïãú Î™®Îì† ÎèôÏûë Ï†ïÏßÄ
                stopTherapy(false);

                if (bleDevice && bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                }

                state.connected = false;
                state.bleDeviceName = '';
                bleDevice = null;
                bleCharacteristic = null;
                updateBleStatus(false);
                showToast('Í∏∞Í∏∞ Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
            } catch (error) {
                console.error('Ïó∞Í≤∞ Ìï¥Ï†ú Ïò§Î•ò:', error);
                state.connected = false;
                updateBleStatus(false);
            }
        }

        async function sendLedCommand(command) {
            if (!state.connected || !bleCharacteristic) {
                showToast("Í∏∞Í∏∞ Ïó∞Í≤∞ ÌïÑÏöî", "error");
                return;
            }

            try {
                // Î™ÖÎ†πÏñ¥Î•º UTF-8 Î∞îÏù¥Ìä∏Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
                const encoder = new TextEncoder();
                const data = encoder.encode(command);

                await bleCharacteristic.writeValue(data);
                console.log("BLE Î™ÖÎ†π Ï†ÑÏÜ° ÏÑ±Í≥µ:", command);

                // Î™ÖÎ†πÏñ¥ ÌååÏã±ÌïòÏó¨ UI ÏóÖÎç∞Ïù¥Ìä∏
                const parts = command.split(':');
                if (parts[0] === 'START' && parts.length === 3) {
                    console.log("LED ÌÖåÎùºÌîº ÏãúÏûë:", parts[1], parts[2] + "Î∂Ñ");
                } else if (parts[0] === 'STOP') {
                    console.log("LED ÌÖåÎùºÌîº Ï§ëÏßÄ");
                }

            } catch (error) {
                console.error("BLE Î™ÖÎ†π Ï†ÑÏÜ° Ïò§Î•ò:", error);
                showToast("Î™ÖÎ†π Ï†ÑÏÜ° Ïã§Ìå®: " + error.message, "error");
            }
        }

        function updateBleStatus(connected, deviceName = '') {
            const pill = document.getElementById('ble-btn-header'); const txt = document.getElementById('ble-text-header');
            const devStatus = document.getElementById('device-tab-status'); const devBtn = document.getElementById('ble-btn-device');

            if (connected) {
                pill.classList.add('connected'); txt.innerText = 'Connected';
                if (devStatus) devStatus.innerHTML = `<span style="color:#10B981">‚óè</span> <b>${deviceName}</b> Ïó∞Í≤∞Îê®`;
                if (devBtn) { devBtn.innerHTML = `Ïó∞Í≤∞ Ìï¥Ï†ú`; devBtn.style.color = '#EF4444'; }
            } else {
                pill.classList.remove('connected'); txt.innerText = 'Connect';
                if (devStatus) devStatus.innerHTML = 'Ïó∞Í≤∞Îêú Í∏∞Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§';
                if (devBtn) { devBtn.innerHTML = `<i class="ph-bold ph-bluetooth-connect"></i> Í∏∞Í∏∞ Ï∞æÍ∏∞`; devBtn.style.color = '#1F2937'; }
            }
        }

        // ============================================
        // 4. Camera Logic
        // ============================================
        async function startAnalysis() { switchTab('analysis'); resetCamera(); }

        function triggerGallery() {
            const fileInput = document.getElementById('file-input');
            // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî (Í∞ôÏùÄ ÌååÏùº Ïû¨ÏÑ†ÌÉù Í∞ÄÎä•)
            fileInput.value = '';
            fileInput.click();
        }

        function handleFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('preview-img');
                    preview.src = e.target.result; preview.style.display = 'block';
                    document.getElementById('cam-guide').style.display = 'none';
                    document.getElementById('btn-group-init').style.display = 'none';
                    document.getElementById('btn-group-capture').style.display = 'none';
                    document.getElementById('btn-group-confirm').style.display = 'flex';
                    state.capturedImage = file;
                }
                reader.readAsDataURL(file);
            }
        }

        // ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω Í∏∞Îä•
        function changePhoto() {
            // ÌååÏùº ÏÑ†ÌÉù Ï∞Ω Ïó¥Í∏∞
            const fileInput = document.getElementById('file-input');

            // Í∏∞Ï°¥ ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÌõÑ Ïû¨Îì±Î°ù (Ï§ëÎ≥µ Î∞©ÏßÄ)
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            newFileInput.onchange = function (e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const preview = document.getElementById('preview-img');
                        preview.src = event.target.result;
                        preview.style.display = 'block';

                        // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        document.getElementById('cam-guide').style.display = 'none';
                        document.getElementById('btn-group-init').style.display = 'none';
                        document.getElementById('btn-group-capture').style.display = 'none';
                        document.getElementById('btn-group-confirm').style.display = 'flex';

                        state.capturedImage = file;
                        showToast('ÏÇ¨ÏßÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§', 'success');
                    }
                    reader.readAsDataURL(file);
                }
            };

            newFileInput.click();
        }

        // Ïû¨Î∂ÑÏÑù Í∏∞Îä• (Í≤∞Í≥º ÌôîÎ©¥ÏóêÏÑú Îã§Î•∏ ÏÇ¨ÏßÑÏúºÎ°ú Ïû¨Î∂ÑÏÑù)
        function reanalyze() {
            // Î∂ÑÏÑù ÌÉ≠ÏúºÎ°ú Ïù¥Îèô
            document.getElementById('analysis-result').classList.add('hidden');
            document.getElementById('analysis-cam').style.display = 'block';

            // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî (Í∞ôÏùÄ ÌååÏùº Ïû¨ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÎèÑÎ°ù)
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.value = '';
            }

            // Ïπ¥Î©îÎùº Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú Î¶¨ÏÖã
            resetCamera();

            showToast('ÏÉàÎ°úÏö¥ ÏÇ¨ÏßÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'info');
        }

        async function startCamera() {
            try {
                if (state.cameraStream) state.cameraStream.getTracks().forEach(t => t.stop());
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 1280 } }, audio: false });

                const frame = document.querySelector('.camera-frame');
                let video = document.getElementById('cameraVideo');
                if (video) video.remove();

                video = document.createElement('video'); video.id = 'cameraVideo';
                video.setAttribute('autoplay', ''); video.setAttribute('playsinline', ''); video.setAttribute('muted', '');
                video.srcObject = stream;
                video.style.cssText = 'width:100%; height:100%; object-fit:cover; transform:scaleX(-1);';
                video.onloadedmetadata = () => { video.play().catch(e => console.log(e)); };

                document.getElementById('preview-img').style.display = 'none';
                document.getElementById('cam-guide').style.display = 'none';
                document.getElementById('face-guide-overlay').style.display = 'flex';
                frame.prepend(video); state.cameraStream = stream;

                document.getElementById('btn-group-init').style.display = 'none';
                document.getElementById('btn-group-capture').style.display = 'block';
                document.getElementById('btn-group-confirm').style.display = 'none';
            } catch (error) { showToast('Ïπ¥Î©îÎùº Í∂åÌïú Ïò§Î•ò', 'error'); }
        }

        async function captureCamera() {
            const video = document.getElementById('cameraVideo');
            if (video && state.cameraStream) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                state.cameraStream.getTracks().forEach(t => t.stop()); state.cameraStream = null; video.remove();
                document.getElementById('face-guide-overlay').style.display = 'none';

                state.capturedImage = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                document.getElementById('preview-img').src = URL.createObjectURL(state.capturedImage);
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('btn-group-capture').style.display = 'none';
                document.getElementById('btn-group-confirm').style.display = 'flex';
            }
        }

        function resetCamera() {
            if (state.cameraStream) { state.cameraStream.getTracks().forEach(t => t.stop()); state.cameraStream = null; }
            const video = document.getElementById('cameraVideo'); if (video) video.remove();
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('cam-guide').style.display = 'block';
            document.getElementById('face-guide-overlay').style.display = 'none';
            document.getElementById('btn-group-init').style.display = 'flex';
            document.getElementById('btn-group-capture').style.display = 'none';
            document.getElementById('btn-group-confirm').style.display = 'none';
            state.capturedImage = null;
        }

        // ============================================
        // 5. AI Analysis (Î∞±ÏóîÎìú Ïó∞Îèô)
        // ============================================
        let currentAnalysisResult = null; // ÌòÑÏû¨ Î∂ÑÏÑù Í≤∞Í≥º Ï†ÄÏû•

        async function runAi() {
            if (!state.capturedImage) { showToast("ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§.", "error"); return; }
            showLoading(true);

            const resultImg = document.getElementById('result-face-img');
            if (resultImg) resultImg.src = URL.createObjectURL(state.capturedImage);

            try {
                const formData = new FormData();
                formData.append('user_id', CONFIG.USER_ID);
                formData.append('file', state.capturedImage, 'face.jpg');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                // Ïã§Ï†ú API Ìò∏Ï∂ú
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/analysis/face`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                // ÏñºÍµ¥ Í∞êÏßÄ Ïã§Ìå® Ï≤òÎ¶¨
                if (response.status === 400) {
                    const errorData = await response.json();
                    if (errorData.error === 'invalid_image') {
                        showLoading(false);
                        showToast(errorData.message, "error");
                        return;
                    }
                }

                if (!response.ok) throw new Error("API ÏùëÎãµ Ïò§Î•ò");
                const result = await response.json();

                console.log("üìä AI Î∂ÑÏÑù Í≤∞Í≥º:", result);
                currentAnalysisResult = result;
                displayAnalysisResult(result);

                // ÏûêÎèôÏúºÎ°ú ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
                await saveToHistory(result);

            } catch (error) {
                console.error("Î∂ÑÏÑù Ïò§Î•ò:", error);

                // ÏñºÍµ¥ Í∞êÏßÄ Ïã§Ìå® Î©îÏãúÏßÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Îç∞Î™® Î™®Îìú
                if (error.message !== "invalid_image") {
                    showToast("AI Î∂ÑÏÑù Ïã§Ìå® (Îç∞Î™® Î™®Îìú ÌôúÏÑ±Ìôî)", "error");
                } else {
                    showLoading(false);
                    return;  // Îç∞Î™® Î™®Îìú ÏßÑÏûÖÌïòÏßÄ ÏïäÏùå
                }

                // Îç∞Î™® Îç∞Ïù¥ÌÑ∞
                const demoResult = {
                    overall_score: Math.floor(Math.random() * 20 + 70),
                    regions: {
                        'forehead': { grade: 8, score: 80, metrics: {} },
                        'eye_l': { grade: 7, score: 75, metrics: {} },
                        'eye_r': { grade: 7, score: 75, metrics: {} },
                        'cheek_l': { grade: 8, score: 80, metrics: {} },
                        'cheek_r': { grade: 8, score: 80, metrics: {} },
                        'chin': { grade: 9, score: 90, metrics: {} }
                    },
                    recommendation: {
                        mode: 'red',
                        duration: 20,
                        reason: 'Ï£ºÎ¶Ñ Î∞è ÌÉÑÎ†• Í∞úÏÑ† ÏßëÏ§ë',
                        target_regions: ['forehead', 'eye_l'],
                        intensity: 75,
                        ble_command: 'START:RED:20'
                    },
                    timestamp: new Date().toISOString()
                };

                currentAnalysisResult = demoResult;
                setTimeout(() => displayAnalysisResult(demoResult), 1500);
            } finally {
                setTimeout(() => showLoading(false), 1500);
            }
        }

        function displayAnalysisResult(result) {
            document.getElementById('analysis-cam').style.display = 'none';
            document.getElementById('analysis-result').classList.remove('hidden');
            document.getElementById('score-display').innerText = Math.round(result.overall_score);

            // Î†àÏù¥Îçî Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            if (typeof Chart !== 'undefined') {
                const canvas = document.getElementById('radarChart');
                const ctx = canvas.getContext('2d');

                // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                const data = Object.values(result.regions).map(r => r.grade * 10);
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Ïù¥Îßà', 'Îàà(Ï¢å)', 'Îàà(Ïö∞)', 'Î≥º(Ï¢å)', 'Î≥º(Ïö∞)', 'ÌÑ±'],
                        datasets: [{
                            label: 'Score',
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10B981',
                            pointBackgroundColor: '#10B981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                ticks: { display: false }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // AI Ï∂îÏ≤ú ÏÜîÎ£®ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            updateRecommendation(result.recommendation);

            // ÏÉÅÏÑ∏ Î©îÌä∏Î¶≠ ÏóÖÎç∞Ïù¥Ìä∏
            updateDetailedMetrics(result.regions);

            // Î°úÏª¨ ÌûàÏä§ÌÜ†Î¶¨ÏóêÎèÑ Ï∂îÍ∞Ä (UI Î∞òÏòÅÏö©)
            state.history.unshift({
                date: new Date().toLocaleDateString(),
                course: 'AI Ï†ïÎ∞Ä Î∂ÑÏÑù',
                score: result.overall_score
            });
        }

        function updateDetailedMetrics(regions) {
            const metricsContent = document.getElementById('metrics-content');
            const metricsContainer = document.getElementById('detailed-metrics');

            if (!regions || !metricsContent) return;

            // Î™®Îì† Î∂ÄÏúÑÏùò Î©îÌä∏Î¶≠ ÏàòÏßë
            const allMetrics = {};
            for (const [regionName, data] of Object.entries(regions)) {
                if (data.metrics) {
                    for (const [metricName, value] of Object.entries(data.metrics)) {
                        if (!allMetrics[metricName]) {
                            allMetrics[metricName] = [];
                        }
                        allMetrics[metricName].push(value);
                    }
                }
            }

            // ÌèâÍ∑† Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
            const metrics = Object.entries(allMetrics)
                .map(([name, values]) => ({
                    name: name,
                    avg: values.reduce((a, b) => a + b, 0) / values.length
                }))
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 8); // ÏÉÅÏúÑ 8Í∞úÎßå

            if (metrics.length > 0) {
                metricsContent.innerHTML = metrics.map(m => {
                    const score = Math.round(m.avg);
                    const color = score > 70 ? '#10B981' : score > 40 ? '#F59E0B' : '#EF4444';
                    return `
                    <div style="background:#F9FAFB; padding:10px; border-radius:12px;">
                        <div style="font-size:11px; color:#666; margin-bottom:4px;">${m.name}</div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div style="flex:1; height:6px; background:#E5E7EB; border-radius:3px; overflow:hidden;">
                                <div style="width:${score}%; height:100%; background:${color}; transition:width 0.5s;"></div>
                            </div>
                            <div style="font-size:12px; font-weight:700; color:${color};">${score}</div>
                        </div>
                    </div>
                `;
                }).join('');
                metricsContainer.style.display = 'block';
            } else {
                metricsContainer.style.display = 'none';
            }
        }

        function toggleMetrics() {
            const container = document.getElementById('detailed-metrics');
            const content = document.getElementById('metrics-content');
            const toggleText = document.getElementById('toggle-text');

            if (content.style.display === 'none') {
                content.style.display = 'grid';
                toggleText.textContent = 'Ï†ëÍ∏∞';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'ÏÉÅÏÑ∏ Î≥¥Í∏∞';
            }
        }

        function updateRecommendation(recommendation) {
            if (!recommendation) return;

            const solutionCard = document.querySelector('.solution-card');
            const iconMap = { red: 'ph-flower', blue: 'ph-drop', gold: 'ph-sparkle' };
            const colorMap = { red: '#EF4444', blue: '#3B82F6', gold: '#F59E0B' };
            const nameMap = { red: 'Red ÌÉÑÎ†• ÏΩîÏä§', blue: 'Blue ÏßÑÏ†ï ÏΩîÏä§', gold: 'Gold ÎØ∏Î∞± ÏΩîÏä§' };

            const icon = iconMap[recommendation.mode] || 'ph-flower';
            const color = colorMap[recommendation.mode] || '#10B981';
            const name = nameMap[recommendation.mode] || 'ÎßûÏ∂§ ÏºÄÏñ¥';

            solutionCard.innerHTML = `
            <div style="font-size:32px; color:${color};">
                <i class="ph-fill ${icon}"></i>
            </div>
            <div>
                <div style="font-weight:700; font-size:16px;">${name}</div>
                <div style="font-size:13px; color:#666;">${recommendation.reason} (${recommendation.duration}Î∂Ñ Ï∂îÏ≤ú)</div>
            </div>
        `;

            // Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
            const applyBtn = document.querySelector('.btn-green');
            applyBtn.onclick = () => applyCourse(recommendation.mode, recommendation.duration, name);
            applyBtn.innerHTML = `ÏÜîÎ£®ÏÖò ÎîîÎ∞îÏù¥Ïä§ Ï†ÑÏÜ° <i class="ph-bold ph-arrow-right"></i>`;

            console.log(`üí° AI Ï∂îÏ≤ú: ${recommendation.mode.toUpperCase()} Î™®Îìú, ${recommendation.duration}Î∂Ñ, Í∞ïÎèÑ ${recommendation.intensity}%`);
            console.log(`üì± BLE Î™ÖÎ†π: ${recommendation.ble_command}`);
        }

        // ÌûàÏä§ÌÜ†Î¶¨ ÏûêÎèô Ï†ÄÏû•
        async function saveToHistory(analysisResult) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: CONFIG.USER_ID,
                        overall_score: analysisResult.overall_score,
                        regions: analysisResult.regions,
                        recommendation: analysisResult.recommendation,
                        timestamp: analysisResult.timestamp,
                        course_name: 'AI Ï†ïÎ∞Ä Î∂ÑÏÑù'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû• ÏôÑÎ£å:', result.record_id);
                }
            } catch (error) {
                console.warn('ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû• Ïã§Ìå® (Ïò§ÌîÑÎùºÏù∏ Î™®Îìú):', error);
            }
        }

        // ============================================
        // 6. Device Control (Manual & Loop)
        // ============================================

        // [Loop Logic 1] Î£®ÌîÑ ÏãúÏûë (Ï¥à Îã®ÏúÑ ÌÅê ÏÉùÏÑ±Í∏∞ Ìè¨Ìï®)
        function startLoopCourse(courseKey) {
            if (!state.connected) { showToast("Í∏∞Í∏∞Î•º Î®ºÏ†Ä Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî.", "error"); return; }
            switchTab('device');

            const patternData = LOOP_PATTERNS[courseKey];
            if (!patternData) return;

            // Í∏∞Ï°¥ ÎèôÏûë ÏôÑÏ†Ñ Ï§ëÏßÄ
            stopTherapy(false);

            state.isLooping = true;
            state.currentLoopIndex = 0;
            state.power = true;

            // [ÌÅê ÏÉùÏÑ± Î°úÏßÅ] Ï¥ù 15Î∂Ñ(900Ï¥à)ÏùÑ Ï±ÑÏö∏ ÎïåÍπåÏßÄ Ìå®ÌÑ¥ Î∞òÎ≥µ
            const totalSeconds = patternData.totalMin * 60;
            let accumulatedSec = 0;
            state.loopQueue = [];

            while (accumulatedSec < totalSeconds) {
                for (let step of patternData.steps) {
                    // Í∞ùÏ≤¥ Î≥µÏÇ¨Ìï¥ÏÑú ÎÑ£Í∏∞ (ÏïàÏ†ÑÏÑ± ÌôïÎ≥¥)
                    state.loopQueue.push({ ...step });
                    accumulatedSec += step.sec;
                    if (accumulatedSec >= totalSeconds) break;
                }
            }

            // UI Î≥ÄÍ≤Ω (Î£®ÌîÑ Î™®Îìú)
            const btn = document.getElementById('btn-power');
            btn.style.background = '#8B5CF6';
            btn.innerHTML = '<i class="ph-bold ph-stop"></i> Stop Loop Care';
            document.getElementById('loop-status-bar').style.display = 'block';

            runLoopStep();
        }

        // [Loop Logic 2] Îã®Í≥ÑÎ≥Ñ Ïã§Ìñâ (Ï¥à Îã®ÏúÑ)
        function runLoopStep() {
            if (state.currentLoopIndex >= state.loopQueue.length) {
                finishLoop(); return;
            }

            const step = state.loopQueue[state.currentLoopIndex];

            // UI Î∞è ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
            setMode(step.mode);

            // Í∏∞Í∏∞ Î™ÖÎ†π Ï†ÑÏÜ°: Ïó¨Í∏∞ÏÑúÎäî '3Ï¥à'ÎÇò '5Ï¥à' ÎèôÏïàÎßå ÏºúÏßÄÏßÄÎßå, 
            // ÌéåÏõ®Ïñ¥ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Î≥¥ÌÜµ '1Î∂Ñ' Î™ÖÎ†πÏùÑ Î≥¥ÎÇ¥ÎÜìÍ≥† Ïï±Ïù¥ 3Ï¥à Îí§Ïóê Îã§Î•∏ Î™ÖÎ†πÏùÑ Î≥¥ÎÇ¥ÏÑú ÎÅäÏñ¥Î≤ÑÎ¶¨Îäî Î∞©ÏãùÏùÑ ÏîÅÎãàÎã§.
            // ÎòêÎäî ÌéåÏõ®Ïñ¥Í∞Ä Ï¥à Îã®ÏúÑÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäîÎã§Î©¥ START:RED:1 (ÏµúÏÜå 1Î∂Ñ)ÏùÑ Î≥¥ÎÇ¥Í≥† 3Ï¥à Îí§Ïóê START:BLUE:1ÏùÑ Î≥¥ÎÇ¥Î©¥ Îê©ÎãàÎã§.
            // Ïó¨Í∏∞ÏÑúÎäî ÏßÅÍ¥ÄÏ†ÅÏúºÎ°ú step.secÏùÑ Î≥¥ÎÇ¥ÏßÄÎßå, Ïã§Ï†úÎ°úÎäî Ïï± ÌÉÄÏù¥Î®∏Í∞Ä Ï†úÏñ¥Ìï©ÎãàÎã§.
            sendLedCommand(`START:${step.mode.toUpperCase()}:1`);

            // showToastÎäî ÎÑàÎ¨¥ ÎπàÎ≤àÌïòÎ©¥ ÏãúÎÅÑÎü¨Ïö∞ÎØÄÎ°ú Ï≤´ ÏãúÏûëÏù¥ÎÇò 10Î≤àÏß∏ÎßàÎã§ Î≥¥Ïó¨Ï£ºÍ±∞ÎÇò ÏÉùÎûµ Í∞ÄÎä•
            // showToast(`${step.name}`, 'success');

            // ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï (Ï¥à Îã®ÏúÑ)
            let remainingSeconds = step.sec;
            const totalSeconds = step.sec;

            updateLoopUI(step, remainingSeconds, totalSeconds);

            if (state.loopTimerDetails) clearInterval(state.loopTimerDetails);

            state.loopTimerDetails = setInterval(() => {
                remainingSeconds--;
                updateLoopUI(step, remainingSeconds, totalSeconds);

                if (remainingSeconds <= 0) {
                    clearInterval(state.loopTimerDetails);
                    state.currentLoopIndex++; // Îã§Ïùå Îã®Í≥ÑÎ°ú
                    runLoopStep();
                }
            }, 1000);
        }

        // [Loop Logic 3] Î£®ÌîÑ UI Í∞±Ïã†
        function updateLoopUI(step, remain, total) {
            // Ï†ÑÏ≤¥ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞ (ÌòÑÏû¨ Ïù∏Îç±Ïä§ Í∏∞Î∞ò)
            const totalSteps = state.loopQueue.length;
            const currentIdx = state.currentLoopIndex;
            const percent = ((currentIdx) / totalSteps) * 100;

            const colors = { red: '#EF4444', blue: '#3B82F6', gold: '#F59E0B' };

            document.getElementById('loop-step-text').innerText = `${step.name}`;
            // ÎÇ®ÏùÄ Ï†ÑÏ≤¥ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ÏùÄ Î≥µÏû°ÌïòÎØÄÎ°ú ÌòÑÏû¨ Ïä§ÌÖùÏùò ÎÇ®ÏùÄ ÏãúÍ∞ÑÎßå ÌëúÏãúÌïòÍ±∞ÎÇò Ïã¨ÌîåÌïòÍ≤å Ï≤òÎ¶¨
            document.getElementById('loop-timer-text').innerText = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${remain}s`;

            const prog = document.getElementById('loop-progress');
            prog.style.width = `${percent}%`;
            prog.style.background = colors[step.mode];
        }

        function finishLoop() {
            showToast("Î™®Îì† ÏΩîÏä§Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.", "success");
            stopTherapy(true);
        }

        // [Common] ÌÜµÌï© Ï§ëÏßÄ Ìï®Ïàò
        function stopTherapy(sendBleCmd = true) {
            state.power = false;
            state.isLooping = false;
            state.loopQueue = [];

            if (state.loopTimerDetails) clearInterval(state.loopTimerDetails);
            state.loopTimerDetails = null;

            // UI Î¶¨ÏÖã
            const btn = document.getElementById('btn-power');
            btn.style.background = '#1F2937';
            btn.innerHTML = '<i class="ph-bold ph-power"></i> Start Therapy';

            document.getElementById('mask-visual').className = 'mask-visual';
            document.getElementById('loop-status-bar').style.display = 'none';

            if (sendBleCmd && state.connected) {
                sendLedCommand("STOP");
            }
        }

        // [Manual] ÏàòÎèô Ï†úÏñ¥ Î≤ÑÌäº
        function togglePower() {
            if (!state.connected) { showToast("Î®ºÏ†Ä Í∏∞Í∏∞Î•º Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî.", "error"); return; }

            if (state.power) {
                stopTherapy(true);
                showToast("ÌÖåÎùºÌîº Ï¢ÖÎ£å", "info");
            } else {
                // ÏàòÎèô ÏãúÏûë
                state.power = true;
                state.isLooping = false;

                const btn = document.getElementById('btn-power');
                btn.style.background = '#EF4444';
                btn.innerHTML = '<i class="ph-bold ph-stop"></i> Stop Therapy';

                document.getElementById('mask-visual').className = 'mask-visual ' + state.mode;

                sendLedCommand("START:" + state.mode.toUpperCase() + ":" + state.time);
                showToast("ÌÖåÎùºÌîº ÏãúÏûë", "success");
            }
        }

        function setMode(mode) {
            state.mode = mode;
            const waves = { red: 630, blue: 415, gold: 590 };
            state.wavelength = waves[mode];

            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('mode-' + mode);
            if (btn) btn.classList.add('active');

            const visual = document.getElementById('mask-visual');
            if (state.power && visual) visual.className = 'mask-visual ' + mode;

            document.getElementById('device-title').innerText = mode.charAt(0).toUpperCase() + mode.slice(1) + ' Mode';

            if (state.power && !state.isLooping && state.connected) {
                sendLedCommand("MODE:" + mode.toUpperCase());
            }
        }

        function updateTime(val) {
            state.time = val;
            document.getElementById('time-val').innerText = val + ' min';
            document.getElementById('device-subtitle').innerText = `${state.wavelength}nm ¬∑ ${val} min`;
        }

        function applyCourse(mode, time, name) {
            switchTab('device');
            stopTherapy(false);

            setMode(mode);
            updateTime(time);
            document.getElementById('time-slider').value = time;
            document.getElementById('device-title').innerText = name;
            showToast(`${name} ÏÑ§Ï†ïÎê® (ÏàòÎèô ÏãúÏûë ÌïÑÏöî)`, "success");
        }

        function showLoading(show) {
            const existing = document.getElementById('loadingOverlay');
            if (show) {
                if (existing) return;
                const div = document.createElement('div'); div.id = 'loadingOverlay';
                div.innerHTML = `<div style="background:rgba(255,255,255,0.95); padding:30px 40px; border-radius:24px; text-align:center;"><div style="width:50px; height:50px; border:4px solid #E5E7EB; border-top-color:#10B981; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px;"></div><div style="font-weight:700;">AI ÌîºÎ∂Ä Î∂ÑÏÑù Ï§ë...</div></div>`;
                document.body.appendChild(div);
            } else if (existing) existing.remove();
        }

        // ÌûàÏä§ÌÜ†Î¶¨ Î†åÎçîÎßÅ (Î∞±ÏóîÎìú Ïó∞Îèô)
        async function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Î°úÎî© Ï§ë...</div>';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/v1/history/${CONFIG.USER_ID}?limit=10`);

                if (response.ok) {
                    const data = await response.json();
                    const history = data.history || [];

                    if (history.length === 0) {
                        list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
                    } else {
                        list.innerHTML = history.map(item => {
                            const date = new Date(item.timestamp).toLocaleDateString('ko-KR', {
                                year: 'numeric', month: 'short', day: 'numeric'
                            });
                            return `<div style="background:white; padding:16px; border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; gap:12px; align-items:center;"><div style="font-size:24px; color:#4B5563;"><i class="ph-fill ph-chart-line-up"></i></div><div><div style="font-weight:700; font-size:14px;">${item.course_name || 'AI Î∂ÑÏÑù'}</div><div style="font-size:12px; color:#999;">${date}</div></div></div><div style="font-size:16px; font-weight:700; color:#10B981">${Math.round(item.overall_score)}</div></div>`;
                        }).join('');
                        renderHistoryChart(history);
                    }
                } else {
                    throw new Error('Î°úÎìú Ïã§Ìå®');
                }
            } catch (error) {
                console.warn('ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                list.innerHTML = state.history.length === 0 ? '<div style="text-align:center; padding:40px; color:#999;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>' :
                    state.history.map(item => `<div style="background:white; padding:16px; border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; gap:12px; align-items:center;"><div style="font-size:24px; color:#4B5563;"><i class="ph-fill ph-chart-line-up"></i></div><div><div style="font-weight:700; font-size:14px;">${item.course}</div><div style="font-size:12px; color:#999;">${item.date}</div></div></div><div style="font-size:16px; font-weight:700; color:#10B981">${Math.round(item.score)}</div></div>`).join('');
                renderHistoryChart(state.history.map(h => ({ overall_score: h.score, timestamp: new Date() })));
            }
        }

        function renderHistoryChart(history) {
            if (typeof Chart === 'undefined') return;
            const canvas = document.getElementById('lineChart');
            const ctx = canvas.getContext('2d');
            const existingChart = Chart.getChart(ctx);
            if (existingChart) existingChart.destroy();

            const recentHistory = history.slice(0, 7).reverse();
            const scores = recentHistory.map(h => h.overall_score);
            const labels = recentHistory.map((h, i) => {
                if (i === recentHistory.length - 1) return 'Today';
                const date = h.timestamp ? new Date(h.timestamp) : null;
                return date ? `${date.getMonth() + 1}/${date.getDate()}` : `${i + 1}`;
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Score', data: scores, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, fill: true, pointRadius: 4, pointBackgroundColor: '#10B981' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 100, ticks: { stepSize: 20 } }, x: { grid: { display: false } } } }
            });
        }
    </script>
</body>

</html>